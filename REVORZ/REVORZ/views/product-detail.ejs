<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalog Produk - Detail Produk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/global.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #fdfbfb,  #f9fdff, #b8dcff, #85dcff);
            min-height: 100vh;
        }
        .tab-button.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }
        .popup-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        .popup-notification.show {
            transform: translateX(0);
        }
        .popup-notification.success {
            background: linear-gradient(135deg, #2dd4bf, #14b8a6);
        }
        .popup-notification.error {
            background: linear-gradient(135deg, #f87171, #ef4444);
        }
    </style>
</head>
<body class="font-sans bg-gray-100 text-gray-800 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-md py-4">
        <div class="container mx-auto flex justify-between items-center px-4">
            <a href="/" class="flex items-center space-x-2">
                <img src="/image/Logo.png" alt="REVOZ Logo" class="w-auto h-14">
                <span class="text-2xl font-bold text-blue-600">REVOZ</span>
            </a>
            <nav class="hidden md:flex space-x-6 ml-8">
                <a href="/" class="text-gray-600 hover:text-blue-600 transition duration-300">Beranda</a>
                <a href="/catalog" class="text-gray-600 hover:text-blue-600 transition duration-300">Katalog</a>
                <a href="/category" class="text-gray-600 hover:text-blue-600 transition duration-300">Kategori</a>
                <a href="/about" class="text-gray-600 hover:text-blue-600 transition duration-300">Tentang Kami</a>
                <a href="/contact" class="text-gray-600 hover:text-blue-600 transition duration-300">Kontak</a>
                <% if (role === 'admin') { %>
                    <a href="/admin/add-product" class="text-gray-600 hover:text-blue-600 transition duration-300">Tambah Produk</a>
                <% } %>
            </nav>

            <!-- Search Bar -->
            <div class="flex-1 flex justify-center px-8">
                <form action="/category" method="get" class="w-full max-w-lg">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <input class="search-input w-full pl-10 pr-4 py-2 rounded-full text-gray-700 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" type="text" name="q" placeholder="Cari produk...">
                    </div>
                </form>
            </div>
            <div class="flex items-center space-x-4">
                <% if (isLoggedIn) { %>
                <div class="flex items-center space-x-2">
                    <% if (profilePicture) { %>
                    <img src="<%= profilePicture %>" alt="Profile Picture" class="w-8 h-8 rounded-full object-cover">
                    <% } else { %>
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                        <%= username.charAt(0).toUpperCase() %>
                    </div>
                    <% } %>
                    <a href="/profile" class="text-gray-600 hover:text-blue-600 transition duration-300">Halo, <%= username %></a>
                </div>
                <% } else { %>
                <a href="/login" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-300">Masuk</a>
                <% } %>
                <a href="/cart" class="relative text-gray-600 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 0a2 2 0 100 4 2 2 0 000-4z" /></svg>
                    <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-1"><%= cartItemCount %></span>
                </a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto py-8 px-4">
        <% 
            let totalRating = 0;
            let averageRating = 0;
            if (ratings && ratings.length > 0) {
                ratings.forEach(r => totalRating += r.rating);
                averageRating = totalRating / ratings.length;
            }
        %>

        <!-- Breadcrumbs -->
        <nav class="text-sm text-gray-500 mb-6">
            <a href="/" class="hover:underline">Beranda</a> &gt; <a href="/category" class="hover:underline">Semua Produk</a> &gt; <span class="font-semibold"><%= product.name %></span>
        </nav>

        <div class="flex flex-col md:flex-row gap-8 bg-white p-8 rounded-lg shadow-md">
            <!-- Product Image Gallery -->
            <div class="w-full md:w-1/2">
                <img id="main-product-image" src="<%= product.image || '/image/Jam.png' %>" alt="<%= product.name %>" class="w-full h-auto rounded-lg shadow-lg mb-4">
                <div class="flex space-x-2 overflow-x-auto" id="thumbnail-gallery">
                    <% 
                        let allImages = [];
                        if (product && product.image) allImages.push(product.image);
                        if (product && product.jenis) allImages = allImages.concat(product.jenis.split(','));
                        if (allImages.length > 0) {
                            allImages.forEach(function(imgSrc, index) {
                    %>
                                <img src="<%= imgSrc %>" alt="Thumbnail <%= index + 1 %>" class="w-24 h-24 object-cover rounded-md cursor-pointer border-2 <%= index === 0 ? 'border-blue-600' : 'border-transparent' %> hover:border-blue-600 thumbnail-image" data-main-image="<%= imgSrc %>">
                    <%      });
                        } else { %>
                            <img src="/image/Jam.png" alt="Default Thumbnail" class="w-24 h-24 object-cover rounded-md cursor-pointer border-2 border-blue-600 thumbnail-image" data-main-image="/image/Jam.png">
                    <%  } %>
                </div>
            </div>

            <!-- Product Information -->
            <div class="w-full md:w-1/2">
                <h1 class="text-4xl font-bold mb-2 text-gray-900"><%= product.name %></h1>
                <div class="flex items-center mb-4">
                    <% if (ratings && ratings.length > 0) { %>
                        <div class="text-yellow-400 flex">
                            <% for(let i = 0; i < 5; i++) { %>
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.683-1.539 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.565-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.92 8.729c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" fill="<%= (i < averageRating) ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="<%= (i < averageRating) ? 0 : 1.5 %>" />
                                </svg>
                            <% } %>
                        </div>
                        <span class="text-gray-600 ml-2 text-sm">(<%= ratings.length %> ulasan)</span>
                    <% } else { %>
                        <span class="text-gray-500 text-sm">Belum ada ulasan</span>
                    <% } %>
                </div>
                <p class="text-gray-800 text-3xl font-bold mb-6">Rp <%= product.price.toLocaleString('id-ID') %></p>

                <!-- Variants -->
                <div class="mb-6">
                    <label for="color" class="block text-gray-700 font-semibold mb-2">Warna:</label>
                    <div class="relative">
                        <select id="color" name="color" class="block appearance-none w-full md:w-1/2 bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-md leading-tight focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200 shadow-sm">
                            <% if (product.warna) { product.warna.split(',').forEach(function(o) { %><option><%= o.trim() %></option><% }); } else { %><option>Tidak Tersedia</option><% } %>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="size" class="block text-gray-700 font-semibold mb-2">Ukuran:</label>
                    <div class="relative">
                        <select id="size" name="size" class="block appearance-none w-full md:w-1/2 bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-md leading-tight focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200 shadow-sm">
                            <% if (product.ukuran) { product.ukuran.split(',').forEach(function(o) { %><option><%= o.trim() %></option><% }); } else { %><option>Tidak Tersedia</option><% } %>
                        </select>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center mb-8">
                    <label for="quantity" class="text-gray-700 font-semibold mr-4">Kuantitas:</label>
                    <input type="number" id="quantity" value="1" min="1" class="w-20 p-2 border border-gray-300 rounded-md text-center focus:ring-blue-500 focus:border-blue-500">
                    <button id="add-to-cart-btn" data-product-id="<%= product.id %>" class="ml-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg transition duration-300 shadow-lg">Tambahkan ke Keranjang</button>
                </div>
            </div>
        </div>

        <!-- Product Description and Reviews Tabs -->
        <div class="bg-white p-8 rounded-lg shadow-md mt-8">
            <div class="flex border-b border-gray-200 mb-6">
                <button data-tab="description" class="tab-button active py-3 px-6 text-lg font-semibold focus:outline-none">Deskripsi</button>
                <button data-tab="reviews" class="tab-button py-3 px-6 text-lg font-semibold focus:outline-none">Ulasan (<%= ratings.length %>)</button>
            </div>

            <!-- Description Content -->
            <div id="description-content" class="tab-content">
                <h3 class="text-2xl font-semibold mb-4">Detail Produk</h3>
                <div class="text-gray-700 leading-relaxed mb-4"><%- product.description || 'Deskripsi produk tidak tersedia.' %></div>
                <% if (product.spesifikasi) { %>
                    <h4 class="text-xl font-semibold mt-6 mb-2">Spesifikasi Teknis:</h4>
                    <div class="text-gray-700 leading-relaxed"><%- product.spesifikasi.replace(/\n/g, '<br>') %></div>
                <% } %>
            </div>

            <!-- Reviews Content -->
            <div id="reviews-content" class="tab-content hidden">
                <h3 class="text-2xl font-semibold mb-4">Ulasan Pelanggan</h3>
                <% if (ratings && ratings.length > 0) { %>
                    <div class="space-y-6">
                        <% ratings.forEach(function(rating) { %>
                            <div class="border-b border-gray-200 pb-4">
                                <div class="flex items-center mb-2">
                                    <div class="text-yellow-400 flex">
                                        <% for(let i = 0; i < 5; i++) { %>
                                            <svg class="w-5 h-5 <%= i < rating.rating ? 'text-yellow-400' : 'text-gray-300' %>" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.683-1.539 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.565-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.92 8.729c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z"></path></svg>
                                        <% } %>
                                    </div>
                                </div>
                                <p class="text-gray-600 mb-2 text-sm">Oleh <span class="font-semibold"><%= rating.username %></span> pada <%= new Date(rating.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) %></p>
                                <p class="text-gray-700"><%= rating.review || "" %></p>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="text-center py-8 text-gray-500">
                        <p>Belum ada ulasan untuk produk ini.</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Related Products -->
        <section class="py-12">
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-900">Produk Terkait</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <% if (relatedProducts && relatedProducts.length > 0) { %>
                    <% relatedProducts.forEach(function(p) { %>
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden transform transition duration-300 hover:scale-105">
                            <a href="/product/<%= p.id %>"><img src="<%= p.image || '/image/katalog.png' %>" alt="<%= p.name %>" class="w-full h-48 object-cover"></a>
                            <div class="p-4">
                                <h3 class="text-lg font-semibold mb-1"><a href="/product/<%= p.id %>" class="hover:text-blue-600"><%= p.name %></a></h3>
                                <p class="text-gray-700 text-sm mb-2"><%= (p.description || '').replace(/<[^>]+>/g, '').substring(0, 50) + '...' %></p>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-600 font-bold">Rp <%= p.price ? p.price.toLocaleString('id-ID') : '0' %></span>
                                    <a href="/product/<%= p.id %>" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-full text-xs transition">Lihat Detail</a>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p class="col-span-full text-center text-gray-500">Tidak ada produk terkait.</p>
                <% } %>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-auto">
        <div class="container mx-auto text-center px-4">
            <p>&copy; 2025 REVOZ. Semua Hak Dilindungi.</p>
        </div>
    </footer>

</body>
<script>
    const isLoggedIn = JSON.parse('<%- JSON.stringify(isLoggedIn) %>');

    async function postJson(url, body) {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        return res.json();
    }

    function showPopup(message, success = true) {
        const popup = document.createElement('div');
        popup.className = `popup-notification ${success ? 'success' : 'error'}`;
        const icon = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">${success ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'}</svg>`;
        popup.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(popup);
        setTimeout(() => popup.classList.add('show'), 100);
        setTimeout(() => { popup.classList.remove('show'); popup.addEventListener('transitionend', () => popup.remove()); }, 3000);
    }

        document.getElementById('add-to-cart-btn')?.addEventListener('click', async function(){
            if (!isLoggedIn) { window.location.href = '/login'; return; }
            const id = this.dataset.productId;
            const qty = parseInt(document.getElementById('quantity').value, 10) || 1;
            const warna = document.getElementById('color').value;
            const ukuran = document.getElementById('size').value;
            const r = await postJson('/api/cart/add', { product_id: id, quantity: qty, warna: warna, ukuran: ukuran });
            if (r && r.ok) { showPopup('Produk ditambahkan ke keranjang'); } 
            else { showPopup(r.message || 'Gagal menambahkan ke keranjang', false); }
        });
    // Image gallery functionality
    const mainProductImage = document.getElementById('main-product-image');
    const thumbnailImages = document.querySelectorAll('.thumbnail-image');
    thumbnailImages.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            mainProductImage.src = thumbnail.dataset.mainImage;
            thumbnailImages.forEach(img => img.classList.remove('border-blue-600'));
            thumbnail.classList.add('border-blue-600');
        });
    });


    // Tab functionality
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            tabContents.forEach(content => {
                content.id === `${tab}-content` ? content.classList.remove('hidden') : content.classList.add('hidden');
            });
        });
    });
</script>
</html>